<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>K8S-Janus | {{ name }}</title>
  <link rel="icon" type="image/png" href="/static/k8s-janus-logo-white.png">
  <script>
    var _phase = {{ status.get("phase", "Pending") | tojson }};
    if (_phase === 'Pending' || _phase === 'Approved') {
      function scheduleReload() {
        setTimeout(function() {
          if (document.visibilityState === 'hidden') {
            document.addEventListener('visibilitychange', function() { location.reload(); }, { once: true });
          } else {
            location.reload();
          }
        }, 5000);
      }
      scheduleReload();
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <style>
    :root {
      --bg:          #080c14;
      --surface:     #0d1117;
      --surface-2:   #161b27;
      --surface-3:   #1e2535;
      --border:      #2a3448;
      --border-light:#334155;
      --text:        #e2e8f0;
      --text-muted:  #94a3b8;
      --text-dim:    #64748b;
      --accent:      #6366f1;
      --accent-glow: rgba(99,102,241,0.35);
      --accent-2:    #8b5cf6;
      --success:     #10b981;
      --warning:     #f59e0b;
      --danger:      #ef4444;
      --info:        #3b82f6;
      --radius:      12px;
      --radius-sm:   8px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      background-image:
        radial-gradient(ellipse 80% 40% at 50% -10%, rgba(99,102,241,0.12) 0%, transparent 70%);
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      background: rgba(13,17,23,0.85);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border);
      padding: 0 32px;
      height: 76px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-brand { display: flex; align-items: center; gap: 12px; }
    .header-logo {
      width: 46px; height: 46px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 20px var(--accent-glow);
    }
    .header-logo svg { color: #fff; }
    .brand-text h1 {
      font-size: 1.25rem; font-weight: 700; letter-spacing: -0.02em;
      background: linear-gradient(135deg, #e2e8f0, #94a3b8);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .brand-text span { font-size: 0.72rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }
    .header-pill {
      display: flex; align-items: center; gap: 6px;
      background: var(--surface-2); border: 1px solid var(--border);
      border-radius: 20px; padding: 4px 12px 4px 8px;
      font-size: 0.75rem; color: var(--text-muted);
    }
    .pulse-dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--success); box-shadow: 0 0 8px var(--success);
      animation: pulse-anim 2s ease-in-out infinite;
    }
    @keyframes pulse-anim {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(0.85); }
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
    .container { max-width: 760px; margin: 40px auto; padding: 0 20px; }

    /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 28px;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent-glow), transparent);
    }
    .card-header {
      display: flex; align-items: center; gap: 10px; margin-bottom: 24px;
    }
    .card-icon {
      width: 32px; height: 32px;
      background: var(--surface-2); border: 1px solid var(--border);
      border-radius: 8px; display: flex; align-items: center; justify-content: center;
      color: var(--accent);
    }
    .card-header h2 { font-size: 0.95rem; font-weight: 600; color: var(--text); }

    /* ‚îÄ‚îÄ BADGE ‚îÄ‚îÄ */
    .badge {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 4px 12px; border-radius: 20px;
      font-size: 0.78rem; font-weight: 600; letter-spacing: 0.03em;
    }
    .badge-dot { width: 6px; height: 6px; border-radius: 50%; }

    .badge-pending  { background: rgba(245,158,11,0.12); color: #fbbf24; border: 1px solid rgba(245,158,11,0.25); }
    .badge-pending .badge-dot  { background: #fbbf24; box-shadow: 0 0 6px #f59e0b; animation: pulse-anim 1.5s infinite; }
    .badge-approved { background: rgba(16,185,129,0.12); color: #34d399; border: 1px solid rgba(16,185,129,0.25); }
    .badge-approved .badge-dot { background: #34d399; }
    .badge-active   { background: rgba(99,102,241,0.15); color: #a5b4fc; border: 1px solid rgba(99,102,241,0.3); }
    .badge-active .badge-dot   { background: #818cf8; box-shadow: 0 0 8px var(--accent); animation: pulse-anim 2s infinite; }
    .badge-denied   { background: rgba(239,68,68,0.1);  color: #fca5a5; border: 1px solid rgba(239,68,68,0.25); }
    .badge-denied .badge-dot   { background: #f87171; }
    .badge-expired  { background: rgba(100,116,139,0.12); color: #94a3b8; border: 1px solid rgba(100,116,139,0.2); }
    .badge-expired .badge-dot  { background: #64748b; }
    .badge-revoked  { background: rgba(239,68,68,0.1);  color: #fca5a5; border: 1px solid rgba(239,68,68,0.25); }
    .badge-revoked .badge-dot  { background: #f87171; }
    .badge-failed   { background: rgba(239,68,68,0.15); color: #fca5a5; border: 1px solid rgba(239,68,68,0.35); }
    .badge-failed .badge-dot   { background: #ef4444; }

    /* ‚îÄ‚îÄ FACT GRID ‚îÄ‚îÄ */
    .fact-grid {
      display: grid;
      grid-template-columns: 130px 1fr;
      gap: 10px 20px;
    }
    .fact-label {
      font-size: 0.78rem;
      font-weight: 500;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .fact-label svg { flex-shrink: 0; }
    .fact-value {
      font-size: 0.875rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
    }
    .fact-value code {
      background: var(--surface-3);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 2px 8px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      color: #a5b4fc;
    }

    /* ‚îÄ‚îÄ STATUS SPINNER ‚îÄ‚îÄ */
    .spinning-ring {
      display: inline-block;
      width: 16px; height: 16px;
      border: 2px solid var(--border-light);
      border-top-color: #fbbf24;
      border-radius: 50%;
      animation: spin 0.75s linear infinite;
      vertical-align: middle;
      margin-left: 10px;
    }

    /* ‚îÄ‚îÄ ALERT BOXES ‚îÄ‚îÄ */
    .alert {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 16px;
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      margin-top: 20px;
      line-height: 1.5;
    }
    .alert svg { flex-shrink: 0; margin-top: 1px; }
    .alert-info {
      background: rgba(59,130,246,0.1);
      border: 1px solid rgba(59,130,246,0.25);
      color: #93c5fd;
    }
    .alert-warning {
      background: rgba(245,158,11,0.1);
      border: 1px solid rgba(245,158,11,0.25);
      color: #fcd34d;
    }
    .alert-danger {
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.25);
      color: #fca5a5;
    }
    .alert-danger a { color: #f87171; }
    .alert-danger a:hover { text-decoration: underline; }

    /* ‚îÄ‚îÄ TOKEN SECTION ‚îÄ‚îÄ */
    .token-card {
      background: var(--surface);
      border: 1px solid rgba(99,102,241,0.3);
      border-radius: var(--radius);
      padding: 28px;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }
    .token-card::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, transparent, rgba(99,102,241,0.6), transparent);
    }
    .token-card::after {
      content: '';
      position: absolute;
      top: -60px; right: -60px;
      width: 160px; height: 160px;
      background: radial-gradient(circle, rgba(99,102,241,0.08) 0%, transparent 70%);
      pointer-events: none;
    }
    .token-heading {
      display: flex; align-items: center; gap: 10px; margin-bottom: 8px;
    }
    .token-heading h2 {
      font-size: 0.95rem; font-weight: 600; color: var(--text);
    }
    .token-sub {
      font-size: 0.82rem; color: var(--text-dim); margin-bottom: 20px;
    }
    .token-sub strong { color: var(--text-muted); }
    .token-sub code {
      background: var(--surface-3); border: 1px solid var(--border);
      border-radius: 4px; padding: 1px 6px;
      font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: #a5b4fc;
    }

    .token-block-label {
      font-size: 0.72rem; font-weight: 500; color: var(--text-dim);
      text-transform: uppercase; letter-spacing: 0.06em;
      margin-bottom: 6px;
    }
    .token-box {
      background: #0a0e1a;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      color: #a5f3b4;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
      line-height: 1.6;
      position: relative;
      box-shadow: inset 0 0 30px rgba(0,0,0,0.3);
    }
    .token-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .copy-btn {
      padding: 7px 16px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      color: var(--text-muted);
      border-radius: var(--radius-sm);
      font-size: 0.78rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex; align-items: center; gap: 6px;
      transition: background 0.15s, border-color 0.15s, color 0.15s;
      flex-shrink: 0;
    }
    .copy-btn:hover {
      background: var(--surface-3);
      border-color: var(--accent);
      color: var(--text);
    }
    .token-divider {
      height: 1px;
      background: var(--border);
      margin: 20px 0;
    }
    .security-note {
      display: flex; align-items: flex-start; gap: 10px;
      background: rgba(245,158,11,0.07);
      border: 1px solid rgba(245,158,11,0.2);
      border-radius: var(--radius-sm);
      padding: 12px 14px;
      font-size: 0.8rem;
      color: #fcd34d;
      margin-top: 20px;
      line-height: 1.5;
    }
    .security-note svg { flex-shrink: 0; margin-top: 1px; }

    /* ‚îÄ‚îÄ BACK LINK ‚îÄ‚îÄ */
    .back-link {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 0.84rem;
      color: var(--text-dim);
      text-decoration: none;
      padding: 8px 0;
      transition: color 0.15s;
    }
    .back-link:hover { color: var(--text-muted); }
  </style>
</head>
<body>
  <header>
    <a class="header-brand" href="/" style="text-decoration:none;">
      <div class="header-logo">
        <img src="/static/k8s-janus-logo-white.png" style="width:36px;height:36px;object-fit:contain;" alt="K8s-Janus">
      </div>
      <div class="brand-text">
        <h1>K8S-Janus</h1>
        <span>{{ cluster_name }} ¬∑ Watching your every request üëÅÔ∏è</span>
      </div>
    </a>
    <div style="display:flex;align-items:center;gap:10px;">
      <a href="https://github.com/opsmode/k8s-janus" target="_blank" rel="noopener"
         style="color:var(--text-dim);display:flex;align-items:center;padding:4px;border-radius:6px;transition:color 0.15s;" title="View on GitHub"
         onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--text-dim)'">
        <i data-lucide="github" style="width:17px;height:17px;"></i>
      </a>
      <div class="header-pill">
        <span class="pulse-dot"></span>
        {% if user_name %}{{ user_name }}{% else %}God of Gateways{% endif %}
      </div>
    </div>
  </header>

  <div class="container">
    <a class="back-link" href="/" style="display:inline-flex;align-items:center;gap:6px;margin-bottom:16px;">
      <i data-lucide="arrow-left" style="width:15px;height:15px;"></i>
      Back to all requests
    </a>

    <!-- ‚îÄ‚îÄ STATUS CARD ‚îÄ‚îÄ -->
    <div class="card">
      <div class="card-header">
        <div class="card-icon">
          <i data-lucide="file-search" style="width:16px;height:16px;"></i>
        </div>
        <h2>
          Request Status
        </h2>
        <div style="margin-left:auto; display:flex; align-items:center; gap:8px;">
          <span class="badge badge-{{ status.get('phase', 'pending') | lower }}">
            <span class="badge-dot"></span>
            {{ status.get("phase", "Pending") }}
          </span>
          {% if status.get("phase") == "Pending" %}
          <span class="spinning-ring"></span>
          {% endif %}
        </div>
      </div>

      <div class="fact-grid">
        <span class="fact-label">
          <i data-lucide="hash" style="width:12px;height:12px;"></i>
          Request ID
        </span>
        <span class="fact-value">
          <span style="font-family:'JetBrains Mono',monospace; font-size:0.82rem; color:#a5b4fc;">{{ name }}</span>
        </span>

        <span class="fact-label">
          <i data-lucide="user" style="width:12px;height:12px;"></i>
          Requester
        </span>
        <span class="fact-value">{{ spec.get("requester", "‚Äî") }}</span>

        <span class="fact-label">
          <i data-lucide="server" style="width:12px;height:12px;"></i>
          Cluster
        </span>
        <span class="fact-value"><code>{{ cluster_display if cluster_display else spec.get("cluster", "‚Äî") }}</code></span>

        <span class="fact-label">
          <i data-lucide="layers" style="width:12px;height:12px;"></i>
          Namespace
        </span>
        <span class="fact-value"><code>{{ spec.get("namespace", "‚Äî") }}</code></span>

        <span class="fact-label">
          <i data-lucide="clock" style="width:12px;height:12px;"></i>
          Duration
        </span>
        <span class="fact-value">
          {% set ttl = spec.get("ttlSeconds", 3600) %}
          {{ ttl // 3600 }}h {{ (ttl % 3600) // 60 }}m
        </span>

        <span class="fact-label">
          <i data-lucide="message-square" style="width:12px;height:12px;"></i>
          Reason
        </span>
        <span class="fact-value">{{ spec.get("reason", "‚Äî") }}</span>

        {% if status.get("approvedBy") and status.get("phase") == "Approved" %}
        <span class="fact-label">
          <i data-lucide="check-circle" style="width:12px;height:12px;"></i>
          Approved by
        </span>
        <span class="fact-value">{{ status.get("approvedBy") }}</span>
        {% endif %}

        {% if status.get("approvedBy") and status.get("phase") == "Denied" %}
        <span class="fact-label">
          <i data-lucide="x-circle" style="width:12px;height:12px;"></i>
          Denied by
        </span>
        <span class="fact-value">{{ status.get("approvedBy") }}</span>
        {% endif %}

        {% if status.get("denialReason") %}
        <span class="fact-label">
          <i data-lucide="message-circle" style="width:12px;height:12px;"></i>
          Denial Reason
        </span>
        <span class="fact-value">{{ status.get("denialReason") }}</span>
        {% endif %}

        {% if status.get("expiresAt") %}
        <span class="fact-label">
          <i data-lucide="timer" style="width:12px;height:12px;"></i>
          Expires at
        </span>
        <span class="fact-value" style="flex-direction:column;align-items:flex-start;gap:2px;">
          <span>{{ status.get("expiresAt") | to_berlin }}</span>
          {% if status.get("phase") == "Active" %}
          <span id="ttl-countdown" data-expires="{{ status.get('expiresAt') }}"
                style="font-size:0.78rem;font-family:'JetBrains Mono',monospace;"></span>
          {% endif %}
        </span>
        {% endif %}
      </div>

      {% if status.get("phase") == "Pending" %}
      <div style="text-align:center;margin-top:16px;">
        <img src="https://media1.tenor.com/m/kqu5mYFhzewAAAAC/im-waiting-tapping-fingers.gif"
             alt="Waiting..." style="height:120px;border-radius:10px;opacity:0.85;">
      </div>
      <div class="alert alert-info" style="margin-top:12px;">
        <i data-lucide="loader" style="width:16px;height:16px;"></i>
        <span>‚è≥ Waiting for admin approval. This page auto-refreshes every 5 seconds. Go get a coffee ‚Äî or stare at it, we won't judge.</span>
      </div>
      {% endif %}

      {% if status.get("phase") == "Denied" %}
      <div style="text-align:center;margin-top:16px;">
        <img src="https://media1.tenor.com/m/goLw05lGrtEAAAAC/denied-access.gif"
             alt="Access Denied" style="height:110px;border-radius:10px;opacity:0.85;">
      </div>
      <div class="alert alert-danger" style="margin-top:12px;">
        <i data-lucide="x-circle" style="width:16px;height:16px;"></i>
        <div>
          <div style="margin-bottom:8px;">Your request was denied{% if status.get("approvedBy") %} by {{ status.get("approvedBy") }}{% endif %}.</div>
          {% if status.get("denialReason") %}
          <div style="font-weight:500;">Reason: {{ status.get("denialReason") }}</div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      {% if status.get("phase") == "Expired" %}
      <div style="text-align:center;margin-top:16px;">
        <img src="https://media1.tenor.com/m/wwDpbSdP9fgAAAAC/cinderella-12.gif"
             alt="Time's up!" style="height:110px;border-radius:10px;opacity:0.85;">
      </div>
      <div class="alert alert-danger" style="margin-top:12px;">
        <i data-lucide="timer-off" style="width:16px;height:16px;"></i>
        <span>‚åõ This access has expired. The gate has closed. <a href="/">Submit a new request</a> if you somehow still need it.</span>
      </div>
      {% endif %}

      {% if status.get("phase") == "Revoked" %}
      <div class="alert alert-danger">
        <i data-lucide="shield-off" style="width:16px;height:16px;"></i>
        <span>üö´ This access was revoked by an admin. The god of gateways has spoken. Your token is now a pumpkin.</span>
      </div>
      {% endif %}

      {% if status.get("phase") == "Failed" %}
      <div class="alert alert-danger">
        <i data-lucide="alert-circle" style="width:16px;height:16px;"></i>
        <span>üí• Access grant failed: {{ status.get("message", "unknown error") }}. Please contact the DevOps team (they're probably already crying about it).</span>
      </div>
      {% endif %}
    </div>

    <!-- ‚îÄ‚îÄ ACCESS GRANTED CARD ‚îÄ‚îÄ -->
    {% if status.get("phase") == "Active" and token %}
    <div class="token-card">
      <div style="text-align:center;margin-bottom:16px;">
        <img src="https://media1.tenor.com/m/ePBohNr3Ln4AAAAC/yes---full-access-granted.gif"
             alt="Access Granted!" style="height:110px;border-radius:10px;opacity:0.9;">
      </div>
      <div class="token-heading">
        <div class="card-icon" style="border-color:rgba(99,102,241,0.4);">
          <i data-lucide="terminal" style="width:16px;height:16px;"></i>
        </div>
        <h2>Access Granted üéâ</h2>
      </div>
      <p class="token-sub">
        Scoped to <code>{{ spec.get("namespace") }}</code> only.
        Expires at <strong>{{ status.get("expiresAt") | to_berlin }}</strong>.
      </p>

      <a href="/terminal/{{ cluster }}/{{ name }}"
         style="display:inline-flex;align-items:center;gap:8px;padding:10px 20px;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#fff;border:none;border-radius:var(--radius-sm);font-size:0.85rem;font-weight:600;text-decoration:none;box-shadow:0 2px 16px rgba(99,102,241,0.35);margin-top:4px;">
        <i data-lucide="terminal" style="width:15px;height:15px;"></i>
        Open Web Terminal
      </a>

      <div class="security-note" style="margin-top:16px;">
        <i data-lucide="alert-triangle" style="width:15px;height:15px;"></i>
        <span>Scoped to <code style="color:#fcd34d;">pods/exec</code> in <code style="color:#fcd34d;">{{ spec.get("namespace") }}</code> only. Access is revoked automatically on expiry.</span>
      </div>
    </div>
    {% endif %}

    <!-- ‚îÄ‚îÄ APPROVED (waiting for controller) ‚îÄ‚îÄ -->
    {% if status.get("phase") == "Approved" %}
    <div class="alert alert-info">
      <i data-lucide="loader" style="width:16px;height:16px;"></i>
      <span>‚úÖ Approved! The controller is spinning up your RoleBinding as we speak. Please hold ‚Äî this page refreshes automatically. No carrier pigeons were harmed.</span>
    </div>
    {% endif %}

    <!-- ‚îÄ‚îÄ COMMAND HISTORY ‚îÄ‚îÄ -->
    <div class="card" id="cmd-history-card" style="display:none;margin-top:16px;">
      <div class="card-header">
        <div class="card-icon" style="background:linear-gradient(135deg,#334155,#475569);">
          <i data-lucide="terminal" style="width:16px;height:16px;"></i>
        </div>
        <h2>Command History</h2>
        <span id="cmd-count" style="margin-left:auto;font-size:0.75rem;color:var(--text-dim);"></span>
      </div>
      <div id="cmd-list" style="font-family:'JetBrains Mono',monospace;font-size:0.82rem;max-height:320px;overflow-y:auto;padding:4px 0;">
      </div>
    </div>

  </div>

  <script>
    lucide.createIcons();

    // ‚îÄ‚îÄ Expiry countdown ‚îÄ‚îÄ
    (function() {
      var el = document.getElementById('ttl-countdown');
      if (!el) return;
      var expires = new Date(el.dataset.expires);
      function tick() {
        var diff = Math.floor((expires - Date.now()) / 1000);
        if (diff <= 0) {
          el.textContent = 'Expired';
          el.style.color = 'var(--danger)';
          return;
        }
        var h = Math.floor(diff / 3600);
        var m = Math.floor((diff % 3600) / 60);
        var s = diff % 60;
        el.textContent = h > 0
          ? h + 'h ' + m + 'm ' + s + 's remaining'
          : m > 0 ? m + 'm ' + s + 's remaining'
          : s + 's remaining';
        el.style.color = diff < 300 ? 'var(--danger)' : diff < 900 ? 'var(--warning)' : 'var(--success)';
        setTimeout(tick, 1000);
      }
      tick();
    })();

    function copyCmd(id, btn) {
      const text = document.getElementById(id).innerText;
      function onSuccess() {
        btn.innerHTML = '<i data-lucide="check" style="width:13px;height:13px;"></i> Copied!';
        btn.style.borderColor = 'rgba(16,185,129,0.5)';
        btn.style.color = '#34d399';
        lucide.createIcons();
        setTimeout(() => {
          btn.innerHTML = '<i data-lucide="clipboard" style="width:13px;height:13px;"></i> Copy';
          btn.style.borderColor = '';
          btn.style.color = '';
          lucide.createIcons();
        }, 2000);
      }
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(onSuccess);
      } else {
        // Fallback for HTTP (non-secure) origins
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        onSuccess();
      }
    }

    // ‚îÄ‚îÄ Command history (only for Active/Expired/Revoked) ‚îÄ‚îÄ
    (function() {
      const phase = {{ status.get('phase', '') | tojson }};
      const name  = {{ name | tojson }};
      if (!['Active','Expired','Revoked'].includes(phase)) return;
      fetch(`/api/commands/${name}`)
        .then(r => r.json())
        .then(cmds => {
          if (!cmds || cmds.length === 0) return;
          const card = document.getElementById('cmd-history-card');
          const list = document.getElementById('cmd-list');
          const count = document.getElementById('cmd-count');
          card.style.display = '';
          count.textContent = `${cmds.length} command${cmds.length !== 1 ? 's' : ''}`;
          list.innerHTML = cmds.map(c => {
            const ts = c.timestamp ? c.timestamp.substring(0, 19).replace('T', ' ') : '';
            const esc = c.command.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            return `<div style="display:flex;gap:12px;padding:6px 0;border-bottom:1px solid var(--border);">
              <span style="color:var(--text-dim);flex-shrink:0;font-size:0.75rem;min-width:120px;">${ts}</span>
              <span style="color:#a5b4fc;flex-shrink:0;font-size:0.75rem;min-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${c.pod}">${c.pod}</span>
              <span style="color:var(--text);word-break:break-all;">${esc}</span>
            </div>`;
          }).join('');
        })
        .catch(() => {});
    })();
  </script>
</body>
</html>

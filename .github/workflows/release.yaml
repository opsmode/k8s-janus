name: Release

on:
  push:
    tags:
      - 'v*'

env:
  IMAGE: opsmode/k8s-janus

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: echo "tag=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE }}:${{ steps.version.outputs.tag }}
            ${{ env.IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64


  publish-helm:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Import GPG key
        run: |
          echo "${{ secrets.HELM_GPG_KEY }}" | gpg --batch --import
          gpg --export-secret-keys --output ~/.gnupg/secring.gpg

      - name: Set chart version and image tag from release tag
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          sed -i "s/^version:.*/version: ${VERSION}/" helm/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${VERSION}\"/" helm/Chart.yaml
          wget -qO /usr/local/bin/yq \
            https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq
          yq -i '.image.tag = "'${GITHUB_REF_NAME}'"' helm/values.yaml

      - name: Generate changelog for Artifact Hub
        run: |
          PREV_TAG=$(git tag --sort=-version:refname | grep -v "^${GITHUB_REF_NAME}$" | head -1)
          if [ -z "$PREV_TAG" ]; then
            RANGE="HEAD"
          else
            RANGE="${PREV_TAG}..${GITHUB_REF_NAME}"
          fi

          # Dump commits to a temp file â€” skip version-bump bot commits only
          git log "$RANGE" --pretty=format:"%s" | \
            grep -v "^ci: bump chart to" > /tmp/commits.txt

          python3 - /tmp/commits.txt helm/Chart.yaml "${GITHUB_REF_NAME}" <<'PYEOF'
          import re, sys

          commits_file, chart_file, tag = sys.argv[1], sys.argv[2], sys.argv[3]

          kind_map = [
              (r'^feat(\(.+\))?!?:', 'added'),
              (r'^fix(\(.+\))?!?:', 'fixed'),
              (r'^(refactor|perf)(\(.+\))?!?:', 'changed'),
              (r'^(security|sec)(\(.+\))?!?:', 'security'),
              (r'^(remove|deprecate)(\(.+\))?!?:', 'removed'),
          ]

          lines = open(commits_file).read().splitlines()
          entries = []
          for msg in lines:
              msg = msg.strip()
              if not msg:
                  continue
              kind = 'changed'
              for pattern, k in kind_map:
                  if re.match(pattern, msg):
                      kind = k
                      break
              desc = re.sub(r'^[a-z]+(\([^)]+\))?!?: ', '', msg)
              desc = desc.replace('"', '\\"')
              entries.append(f'    - kind: {kind}\n      description: "{desc}"')

          if not entries:
              entries = [f'    - kind: changed\n      description: "Release {tag}"']

          block = 'artifacthub.io/changes: |\n' + '\n'.join(entries) + '\n'

          content = open(chart_file).read()
          content = re.sub(
              r'artifacthub\.io/changes: \|.*?(?=\n\S|\Z)',
              block.rstrip(),
              content,
              flags=re.DOTALL
          )
          open(chart_file, 'w').write(content)
          print(f"Generated {len(entries)} changelog entries for {tag}")
          PYEOF

      - name: Package and sign Helm chart
        run: |
          helm package helm/ \
            --sign --key "OpsMode" --keyring ~/.gnupg/secring.gpg \
            --destination .deploy/

      - name: Checkout gh-pages branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin gh-pages
          git worktree add gh-pages-dir gh-pages

      - name: Update Helm repo index
        run: |
          cp .deploy/*.tgz gh-pages-dir/
          cp .deploy/*.tgz.prov gh-pages-dir/
          helm repo index gh-pages-dir/ \
            --url https://opsmode.github.io/k8s-janus/ \
            --merge gh-pages-dir/index.yaml

      - name: Push to gh-pages
        run: |
          cd gh-pages-dir
          git add .
          git diff --cached --quiet || git commit -m "helm: release ${{ github.ref_name }}"
          git push origin gh-pages

      - name: Commit chart version bump to main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git stash
          git fetch origin main
          git checkout main
          git pull --rebase origin main
          VERSION=${{ github.ref_name }}
          VERSION_NUM=${VERSION#v}
          yq -i '.image.tag = "'$VERSION'"' helm/values.yaml
          sed -i "s/^version:.*/version: ${VERSION_NUM}/" helm/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${VERSION_NUM}\"/" helm/Chart.yaml
          git add helm/values.yaml helm/Chart.yaml
          git diff --cached --quiet || git commit -m "ci: bump chart to ${VERSION}"
          git push origin main

  release:
    needs: [build, publish-helm]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          body: |
            ## Docker Image

            ```
            opsmode/k8s-janus:${{ github.ref_name }}
            ```

            ## Deploy via Helm

            ```bash
            helm repo add k8s-janus https://opsmode.github.io/k8s-janus
            helm repo update
            helm upgrade --install k8s-janus k8s-janus/k8s-janus \
              --namespace k8s-janus --create-namespace
            ```

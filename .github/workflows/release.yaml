name: Release

on:
  push:
    tags:
      - 'v*'

env:
  IMAGE_PREFIX: opsmode/k8s-janus

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      controller: ${{ steps.changes.outputs.controller }}
      webui: ${{ steps.changes.outputs.webui }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths since previous tag
        id: changes
        run: |
          # Find the previous tag to diff against
          PREV_TAG=$(git tag --sort=-version:refname | grep -v "^${GITHUB_REF_NAME}$" | head -1)
          if [ -z "$PREV_TAG" ]; then
            # No previous tag — treat everything as changed
            echo "controller=true" >> $GITHUB_OUTPUT
            echo "webui=true" >> $GITHUB_OUTPUT
          else
            echo "Diffing $PREV_TAG..${GITHUB_REF_NAME}"
            CHANGED=$(git diff --name-only "$PREV_TAG" "${GITHUB_REF_NAME}")
            echo "$CHANGED"
            echo "controller=$(echo "$CHANGED" | grep -q '^controller/' && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "webui=$(echo "$CHANGED" | grep -q '^webui/' && echo true || echo false)" >> $GITHUB_OUTPUT
          fi

  build-controller:
    needs: detect-changes
    if: needs.detect-changes.outputs.controller == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: echo "tag=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push controller
        uses: docker/build-push-action@v5
        with:
          context: ./controller
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-controller:${{ steps.version.outputs.tag }}
            ${{ env.IMAGE_PREFIX }}-controller:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Scan controller image with Trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.IMAGE_PREFIX }}-controller:${{ steps.version.outputs.tag }}
          format: table
          severity: CRITICAL,HIGH
          exit-code: '1'
          ignore-unfixed: true


  build-webui:
    needs: detect-changes
    if: needs.detect-changes.outputs.webui == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: echo "tag=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push webui
        uses: docker/build-push-action@v5
        with:
          context: ./webui
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-webui:${{ steps.version.outputs.tag }}
            ${{ env.IMAGE_PREFIX }}-webui:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Scan webui image with Trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.IMAGE_PREFIX }}-webui:${{ steps.version.outputs.tag }}
          format: table
          severity: CRITICAL,HIGH
          exit-code: '1'
          ignore-unfixed: true


  publish-helm:
    needs: [build-controller, build-webui]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Import GPG key
        run: |
          echo "${{ secrets.HELM_GPG_KEY }}" | gpg --batch --import
          gpg --export-secret-keys --output ~/.gnupg/secring.gpg

      - name: Regenerate values schema
        run: |
          pip install pyyaml -q
          python3 scripts/gen-schema.py

      - name: Set chart version from tag
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          sed -i "s/^version:.*/version: ${VERSION}/" helm/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${VERSION}\"/" helm/Chart.yaml

      - name: Generate changelog for Artifact Hub
        env:
          PREV_TAG: ${{ github.ref_name }}
        run: |
          PREV_TAG=$(git tag --sort=-version:refname | grep -v "^${GITHUB_REF_NAME}$" | head -1)
          if [ -z "$PREV_TAG" ]; then
            RANGE="HEAD"
          else
            RANGE="${PREV_TAG}..${GITHUB_REF_NAME}"
          fi

          # Dump commits to a temp file — skip CI bot commits (image tag updates, helm releases)
          git log "$RANGE" --pretty=format:"%an|%s" | \
            grep -v "^github-actions\[bot\]|" | \
            sed 's/^[^|]*|//' > /tmp/commits.txt

          python3 - /tmp/commits.txt helm/Chart.yaml "${GITHUB_REF_NAME}" <<'PYEOF'
          import re, sys

          commits_file, chart_file, tag = sys.argv[1], sys.argv[2], sys.argv[3]

          kind_map = [
              (r'^feat(\(.+\))?!?:', 'added'),
              (r'^fix(\(.+\))?!?:', 'fixed'),
              (r'^(refactor|perf)(\(.+\))?!?:', 'changed'),
              (r'^(security|sec)(\(.+\))?!?:', 'security'),
              (r'^(remove|deprecate)(\(.+\))?!?:', 'removed'),
          ]

          lines = open(commits_file).read().splitlines()
          entries = []
          for msg in lines:
              msg = msg.strip()
              if not msg:
                  continue
              kind = 'changed'
              for pattern, k in kind_map:
                  if re.match(pattern, msg):
                      kind = k
                      break
              # Strip conventional commit prefix
              desc = re.sub(r'^[a-z]+(\([^)]+\))?!?: ', '', msg)
              # Escape any double quotes in description
              desc = desc.replace('"', '\\"')
              entries.append(f'    - kind: {kind}\n      description: "{desc}"')

          if not entries:
              entries = [f'    - kind: changed\n      description: "Release {tag}"']

          block = 'artifacthub.io/changes: |\n' + '\n'.join(entries) + '\n'

          content = open(chart_file).read()
          # Replace the entire annotation value (block scalar) - matches until next non-indented key
          content = re.sub(
              r'artifacthub\.io/changes: \|.*?(?=\n\S|\Z)',
              block.rstrip(),
              content,
              flags=re.DOTALL
          )
          open(chart_file, 'w').write(content)
          print(f"Generated {len(entries)} changelog entries for {tag}")
          PYEOF

      - name: Package and sign Helm chart
        run: |
          helm package helm/ \
            --sign --key "OpsMode" --keyring ~/.gnupg/secring.gpg \
            --destination .deploy/

      - name: Checkout gh-pages branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin gh-pages
          git worktree add gh-pages-dir gh-pages

      - name: Update Helm repo index
        run: |
          cp .deploy/*.tgz gh-pages-dir/
          cp .deploy/*.tgz.prov gh-pages-dir/
          helm repo index gh-pages-dir/ \
            --url https://opsmode.github.io/k8s-janus/ \
            --merge gh-pages-dir/index.yaml

      - name: Push to gh-pages
        run: |
          cd gh-pages-dir
          git add .
          git diff --cached --quiet || git commit -m "helm: release ${{ github.ref_name }}"
          git push origin gh-pages

      - name: Update image tags in values.yaml
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git stash
          git fetch origin main
          git checkout main
          git pull --rebase origin main
          wget -qO /usr/local/bin/yq \
            https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq
          VERSION=${{ github.ref_name }}
          VERSION_NUM=${VERSION#v}
          yq -i '.image.controller.tag = "'$VERSION'"' helm/values.yaml
          yq -i '.image.webui.tag = "'$VERSION'"' helm/values.yaml
          sed -i "s/^version:.*/version: ${VERSION_NUM}/" helm/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${VERSION_NUM}\"/" helm/Chart.yaml
          git add helm/values.yaml helm/Chart.yaml
          git diff --cached --quiet || git commit -m "ci: bump chart to ${VERSION}"
          git push origin main

  release:
    needs: [detect-changes, build-controller, build-webui, publish-helm]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          body: |
            ## Docker Images

            ```
            opsmode/k8s-janus-controller:${{ github.ref_name }}
            opsmode/k8s-janus-webui:${{ github.ref_name }}
            ```

            ## Deploy via Helm

            ```bash
            helm repo add k8s-janus https://opsmode.github.io/k8s-janus
            helm repo update
            helm upgrade --install k8s-janus k8s-janus/k8s-janus \
              --namespace k8s-janus --create-namespace
            ```
